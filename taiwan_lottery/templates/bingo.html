{% extends "base.html" %}
{% block title %}賓果賓果追蹤 - 台灣彩券預測系統{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-grid-3x3-gap-fill"></i> 賓果賓果即時追蹤</h1>
        <p class="text-muted">自動每30秒更新最新開獎結果（每5分鐘一期）</p>
    </div>
</div>

<!-- Latest Draw -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <h5 class="mb-0">最新一期</h5>
        <div>
            <span class="badge bg-dark" id="bingo-latest-term">-</span>
            <span class="badge bg-dark" id="bingo-latest-time">-</span>
            <button class="btn btn-sm btn-dark ms-2" onclick="refreshBingo()">
                <i class="bi bi-arrow-clockwise"></i> 更新
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- 80-number grid -->
        <div class="bingo-grid mx-auto mb-3" id="bingo-grid"></div>

        <div class="row text-center">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <small class="text-muted">和值</small>
                        <div class="fw-bold fs-5" id="bingo-sum">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <small class="text-muted">奇偶比</small>
                        <div class="fw-bold fs-5" id="bingo-odd-even">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <small class="text-muted">區間分佈</small>
                        <div class="fw-bold fs-5" id="bingo-sectors">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <small class="text-muted">自動更新</small>
                        <div>
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Draws -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">最近開獎記錄</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>期別</th>
                        <th>時間</th>
                        <th>開獎號碼</th>
                        <th>和值</th>
                        <th>奇數</th>
                        <th>區間</th>
                    </tr>
                </thead>
                <tbody id="recent-draws"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sector Chart -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">區間趨勢 (最近20期)</h5>
    </div>
    <div class="card-body">
        <canvas id="sectorChart" height="100"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/charts.js"></script>
<script>
let refreshTimer = null;
let sectorChart = null;

function initGrid() {
    const grid = document.getElementById('bingo-grid');
    let html = '';
    for (let i = 1; i <= 80; i++) {
        html += `<div class="bingo-cell" id="cell-${i}">${i}</div>`;
    }
    grid.innerHTML = html;
}

function highlightNumbers(numbers) {
    // Reset all cells
    for (let i = 1; i <= 80; i++) {
        document.getElementById(`cell-${i}`).classList.remove('active');
    }
    // Highlight drawn numbers
    for (const num of numbers) {
        const cell = document.getElementById(`cell-${num}`);
        if (cell) cell.classList.add('active');
    }
}

async function refreshBingo() {
    try {
        const resp = await fetch('/api/v1/bingo/latest');
        if (!resp.ok) {
            document.getElementById('bingo-latest-term').textContent = '尚無資料';
            return;
        }
        const data = await resp.json();

        document.getElementById('bingo-latest-term').textContent = `第 ${data.draw_term} 期`;
        document.getElementById('bingo-latest-time').textContent = data.draw_datetime;
        document.getElementById('bingo-sum').textContent = data.sum_total;
        document.getElementById('bingo-odd-even').textContent =
            `${data.odd_count} : ${20 - data.odd_count}`;
        document.getElementById('bingo-sectors').textContent =
            `${data.sector_1_count}-${data.sector_2_count}-${data.sector_3_count}-${data.sector_4_count}`;

        highlightNumbers(data.numbers);
    } catch (e) {
        console.error('Failed to refresh bingo:', e);
    }

    // Also load recent draws
    loadRecentDraws();
}

async function loadRecentDraws() {
    try {
        const resp = await fetch('/api/v1/bingo/draws?page_size=20');
        const data = await resp.json();

        const draws = data.items || [];
        document.getElementById('recent-draws').innerHTML = draws.map(d => `
            <tr>
                <td>${d.draw_term}</td>
                <td>${d.draw_datetime}</td>
                <td class="bingo-nums">
                    ${d.numbers.map(n => `<span class="ball ball-yellow ball-xs">${n}</span>`).join('')}
                </td>
                <td>${d.sum_total}</td>
                <td>${d.odd_count}</td>
                <td>${d.sector_1_count}-${d.sector_2_count}-${d.sector_3_count}-${d.sector_4_count}</td>
            </tr>
        `).join('') || '<tr><td colspan="6" class="text-center text-muted">尚無資料</td></tr>';

        // Update sector chart
        if (draws.length > 0) {
            updateSectorChart(draws.slice(0, 20).reverse());
        }
    } catch (e) {
        console.error('Failed to load recent draws:', e);
    }
}

function updateSectorChart(draws) {
    const labels = draws.map(d => d.draw_term);

    if (sectorChart) sectorChart.destroy();
    sectorChart = createLineChart('sectorChart', labels, [
        {
            label: '1-20',
            data: draws.map(d => d.sector_1_count),
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231,76,60,0.1)',
            fill: false,
        },
        {
            label: '21-40',
            data: draws.map(d => d.sector_2_count),
            borderColor: '#3498db',
            backgroundColor: 'rgba(52,152,219,0.1)',
            fill: false,
        },
        {
            label: '41-60',
            data: draws.map(d => d.sector_3_count),
            borderColor: '#2ecc71',
            backgroundColor: 'rgba(46,204,113,0.1)',
            fill: false,
        },
        {
            label: '61-80',
            data: draws.map(d => d.sector_4_count),
            borderColor: '#f39c12',
            backgroundColor: 'rgba(243,156,18,0.1)',
            fill: false,
        },
    ]);
}

function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(() => {
        if (document.getElementById('auto-refresh').checked) {
            refreshBingo();
        }
    }, 30000); // 30 seconds
}

document.getElementById('auto-refresh').addEventListener('change', (e) => {
    if (e.target.checked) {
        startAutoRefresh();
    } else {
        clearInterval(refreshTimer);
        refreshTimer = null;
    }
});

document.addEventListener('DOMContentLoaded', () => {
    initGrid();
    refreshBingo();
    startAutoRefresh();
});
</script>
{% endblock %}
