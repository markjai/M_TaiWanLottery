{% extends "base.html" %}
{% block title %}歷史記錄 - {{ game }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-clock-history"></i> 歷史開獎記錄</h1>
        <div class="btn-group mb-3" role="group">
            <a href="/history/lotto649" class="btn btn-outline-danger {% if game == 'lotto649' %}active{% endif %}">大樂透</a>
            <a href="/history/super_lotto" class="btn btn-outline-primary {% if game == 'super_lotto' %}active{% endif %}">威力彩</a>
            <a href="/history/daily_cash" class="btn btn-outline-success {% if game == 'daily_cash' %}active{% endif %}">今彩539</a>
            <a href="/history/bingo" class="btn btn-outline-warning {% if game == 'bingo' %}active{% endif %}">賓果賓果</a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form id="filter-form" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">起始日期</label>
                <input type="date" class="form-control" id="date-from">
            </div>
            <div class="col-md-3">
                <label class="form-label">結束日期</label>
                <input type="date" class="form-control" id="date-to">
            </div>
            <div class="col-md-2">
                <label class="form-label">每頁筆數</label>
                <select class="form-select" id="page-size">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">查詢</button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-secondary" onclick="exportData('csv')">
                    <i class="bi bi-download"></i> CSV
                </button>
                <button type="button" class="btn btn-outline-secondary ms-1" onclick="exportData('json')">
                    <i class="bi bi-download"></i> JSON
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="draws-table">
                <thead id="table-head"></thead>
                <tbody id="table-body">
                    <tr><td colspan="10" class="text-center">載入中...</td></tr>
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <nav id="pagination-nav">
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const GAME = '{{ game }}';
let currentPage = 1;
let allData = [];

const GAME_HEADERS = {
    lotto649: ['期別', '開獎日', '號碼1', '號碼2', '號碼3', '號碼4', '號碼5', '號碼6', '特別號', '和值', '奇數', '跨度'],
    super_lotto: ['期別', '開獎日', '一區1', '一區2', '一區3', '一區4', '一區5', '一區6', '二區', '和值', '奇數', '跨度'],
    daily_cash: ['期別', '開獎日', '號碼1', '號碼2', '號碼3', '號碼4', '號碼5', '和值', '奇數', '跨度'],
    bingo: ['期別', '開獎時間', '號碼 (20個)', '和值', '奇數', '區間分佈'],
};

function renderHead() {
    const headers = GAME_HEADERS[GAME] || [];
    document.getElementById('table-head').innerHTML =
        '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
}

function renderRow(d) {
    if (GAME === 'lotto649') {
        return `<tr>
            <td>${d.draw_term}</td><td>${d.draw_date}</td>
            ${d.numbers_sorted.map(n => `<td><span class="ball ball-red ball-sm">${n}</span></td>`).join('')}
            <td><span class="ball ball-special ball-sm">${d.special_num}</span></td>
            <td>${d.sum_total}</td><td>${d.odd_count}</td><td>${d.span}</td>
        </tr>`;
    } else if (GAME === 'super_lotto') {
        return `<tr>
            <td>${d.draw_term}</td><td>${d.draw_date}</td>
            ${d.zone1_sorted.map(n => `<td><span class="ball ball-blue ball-sm">${n}</span></td>`).join('')}
            <td><span class="ball ball-zone2 ball-sm">${d.zone2_num}</span></td>
            <td>${d.sum_zone1}</td><td>${d.odd_count}</td><td>${d.span}</td>
        </tr>`;
    } else if (GAME === 'daily_cash') {
        return `<tr>
            <td>${d.draw_term}</td><td>${d.draw_date}</td>
            ${d.numbers_sorted.map(n => `<td><span class="ball ball-green ball-sm">${n}</span></td>`).join('')}
            <td>${d.sum_total}</td><td>${d.odd_count}</td><td>${d.span}</td>
        </tr>`;
    } else if (GAME === 'bingo') {
        return `<tr>
            <td>${d.draw_term}</td><td>${d.draw_datetime}</td>
            <td class="bingo-nums">${d.numbers.map(n => `<span class="ball ball-yellow ball-xs">${n}</span>`).join('')}</td>
            <td>${d.sum_total}</td><td>${d.odd_count}</td>
            <td>${d.sector_1_count}-${d.sector_2_count}-${d.sector_3_count}-${d.sector_4_count}</td>
        </tr>`;
    }
    return '';
}

async function loadDraws(page = 1) {
    currentPage = page;
    const pageSize = document.getElementById('page-size').value;
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;

    let url = `/api/v1/${GAME}/draws?page=${page}&page_size=${pageSize}`;
    if (dateFrom) url += `&date_from=${dateFrom}`;
    if (dateTo) url += `&date_to=${dateTo}`;

    try {
        const resp = await fetch(url);
        const data = await resp.json();
        allData = data.items;

        document.getElementById('table-body').innerHTML =
            data.items.length > 0
                ? data.items.map(renderRow).join('')
                : '<tr><td colspan="12" class="text-center text-muted">尚無資料</td></tr>';

        renderPagination(data.page, data.total_pages);
    } catch (e) {
        document.getElementById('table-body').innerHTML =
            `<tr><td colspan="12" class="text-center text-danger">載入失敗: ${e.message}</td></tr>`;
    }
}

function renderPagination(current, total) {
    if (total <= 1) {
        document.getElementById('pagination').innerHTML = '';
        return;
    }
    let html = '';
    html += `<li class="page-item ${current <= 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadDraws(${current - 1}); return false;">上一頁</a></li>`;

    const start = Math.max(1, current - 2);
    const end = Math.min(total, current + 2);
    for (let i = start; i <= end; i++) {
        html += `<li class="page-item ${i === current ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadDraws(${i}); return false;">${i}</a></li>`;
    }

    html += `<li class="page-item ${current >= total ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadDraws(${current + 1}); return false;">下一頁</a></li>`;
    document.getElementById('pagination').innerHTML = html;
}

function exportData(format) {
    if (!allData.length) return alert('無資料可匯出');
    if (format === 'json') {
        const blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${GAME}_draws.json`; a.click();
    } else {
        const headers = Object.keys(allData[0]);
        const csv = [headers.join(','), ...allData.map(row => headers.map(h => {
            const val = row[h];
            return Array.isArray(val) ? `"${val.join(';')}"` : val;
        }).join(','))].join('\n');
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${GAME}_draws.csv`; a.click();
    }
}

document.getElementById('filter-form').addEventListener('submit', (e) => {
    e.preventDefault();
    loadDraws(1);
});

document.addEventListener('DOMContentLoaded', () => {
    renderHead();
    loadDraws(1);
});
</script>
{% endblock %}
